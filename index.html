<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trivia Studio</title>
  <style>
    :root{
      --bg1:#fef9c3;
      --bg2:#a5f3fc;
      --fg:#020617;
      --accent:#f97316;
      --accent2:#ec4899;
      --accent3:#22c55e;
      --danger:#f97373;
      --shadow:8px 8px 0 #020617;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,Noto Sans,"Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(circle at 0 0, var(--bg2) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, var(--accent2) 0, transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }
    html::before{
      content:'';
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(90deg,rgba(15,23,42,0.06) 1px,transparent 1px),
        linear-gradient(180deg,rgba(15,23,42,0.06) 1px,transparent 1px);
      background-size:32px 32px;
      mix-blend-mode:multiply;
      pointer-events:none;
      z-index:0;
    }
    .wrap{width:min(1600px,95vw);height:min(95vh,900px);position:relative;z-index:1;}
    .card{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:1.2rem;
      background:#fefce8;
      border:4px solid #020617;
      border-radius:28px;
      padding:clamp(18px,3vw,38px);
      box-shadow:var(--shadow);
    }
    header{display:flex;align-items:center;justify-content:space-between;gap:1rem;}
    .title{display:flex;align-items:center;gap:.6rem;font-weight:900;letter-spacing:.5px;}
    .title .logo{font-size:clamp(24px,4vw,40px);} .title .text{font-size:clamp(20px,2.6vw,34px);}
    .subtle{opacity:.8;font-size:clamp(12px,1.5vw,16px)}
    .header-right{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;}
    .header-maker-btn{font-size:clamp(12px,1.4vw,16px);padding:.5em 1em;}
    .qa{display:grid;align-content:center;text-align:center;padding:clamp(8px,2vw,16px);} 
    .intro-view{display:none;} .intro-view.show{display:block;animation:fadeIn .5s ease-out;}
    .intro-content{max-width:700px;margin:0 auto;padding:clamp(16px,3vw,32px);}
    .intro-emoji{font-size:clamp(48px,8vw,80px);margin-bottom:clamp(16px,2vh,24px);}
    .intro-title{
      font-size:clamp(36px,6vw,64px);
      font-weight:900;
      line-height:1.1;
      margin:0 0 clamp(12px,2vh,20px) 0;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .intro-text{font-size:clamp(18px,2.5vw,26px);margin:0 0 clamp(24px,4vh,40px) 0;opacity:0.95;}
    .intro-instructions{text-align:left;background:#ffffff;border:3px solid #020617;border-radius:18px;padding:clamp(16px,2vw,24px);margin-bottom:clamp(24px,4vh,40px);box-shadow:4px 4px 0 #020617;}
    .intro-instructions p{margin:0 0 clamp(8px,1.5vh,12px) 0;font-size:clamp(16px,2vw,20px);font-weight:700;color:var(--accent);}
    .intro-instructions ul{margin:0;padding-left:clamp(20px,3vw,28px);list-style:none;}
    .intro-instructions li{margin-bottom:clamp(6px,1vh,10px);font-size:clamp(14px,1.8vw,18px);line-height:1.5;position:relative;padding-left:clamp(16px,2vw,20px);}
    .intro-instructions li::before{content:'‚úì';position:absolute;left:0;color:var(--accent3);font-weight:bold;}
    .ctrl-large{font-size:clamp(18px,2.2vw,24px)!important;padding:0.8em 1.5em!important;margin-top:clamp(8px,1.5vh,16px);}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .question-view{display:block;} .question-view.hidden{display:none!important;}
    .question-image{max-width:100%;max-height:50vh;margin:clamp(16px,3vh,24px) auto;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.3);display:block;object-fit:contain;}
    .answer-view{display:none;text-align:left;} .answer-view.show{display:block!important;animation:slideIn .3s ease-out;}
    .q{font-weight:800;line-height:1.15;font-size:clamp(28px,5.2vw,66px);text-wrap:balance;} 
    .answer-title{font-weight:800;line-height:1.2;font-size:clamp(32px,5vw,56px);color:var(--accent);text-shadow:0 2px 0 #0006;margin-bottom:clamp(16px,3vh,24px);text-align:center;}
    .answer-facts{font-size:clamp(16px,2.2vw,22px);line-height:1.5;color:var(--fg);opacity:0.95;}
    .answer-facts h3{color:var(--accent2);font-size:clamp(20px,2.8vw,28px);margin:clamp(12px,2vh,20px) 0 clamp(8px,1.5vh,12px) 0;font-weight:700;}
    .answer-facts ul{margin:clamp(8px,1.5vh,12px) 0;padding-left:clamp(16px,3vw,24px);}
    .answer-facts li{margin-bottom:clamp(6px,1vh,10px);}
    @keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    footer{display:flex;align-items:center;justify-content:space-between;gap:1rem;} footer.hidden{display:none!important;} .controls{display:flex;flex-wrap:wrap;gap:.5rem;} button.ctrl{font-size:clamp(14px,1.6vw,18px);font-weight:800;color:#020617;background:var(--accent);border-radius:999px;padding:.6em 1.1em;cursor:pointer;box-shadow:4px 4px 0 #020617;border:3px solid #020617;letter-spacing:.03em;text-transform:uppercase;} button.ctrl.secondary{background:var(--accent3);} button.ctrl.ghost{background:#f9fafb;color:var(--fg);border-color:#020617;} button.ctrl:active{transform:translate(2px,2px);box-shadow:2px 2px 0 #020617;} .idx{font-weight:800;opacity:.9;}
    .tips{display:none;}
    .hidden{display:none!important;} .pill{padding:.25em .6em;border-radius:999px;background:#ffffff22;}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,0.65);z-index:10;} .modal .box{width:min(1200px,92vw);max-height:90vh;overflow:auto;background:#f9fafb;border:3px solid #020617;padding:1rem;border-radius:20px;box-shadow:8px 8px 0 #020617;color:#020617;} .modal textarea{width:100%;height:50vh;font:14px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#020617;background:#e5e7eb;border:2px solid #020617;border-radius:12px;padding:10px;} .modal .row{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem}
    .maker-backdrop{position:fixed;inset:0;display:none;place-items:center;background:#000d;z-index:12;}
    .maker-backdrop.show{display:grid;}
    .maker-dialog{width:min(1400px,96vw);height:min(860px,96vh);background:#fefce8;border-radius:24px;box-shadow:var(--shadow);border:4px solid #020617;display:flex;flex-direction:column;overflow:hidden;}
    .maker-header{display:flex;align-items:center;justify-content:space-between;padding:0.9rem 1.2rem;border-bottom:3px solid #020617;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#020617;}
    .maker-title{font-weight:800;font-size:1.05rem;display:flex;flex-direction:column;gap:.1rem;}
    .maker-title span{font-size:.8rem;opacity:.9;}
    .maker-actions{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:flex-end;}
    .maker-body{flex:1;display:grid;grid-template-columns:minmax(220px,320px) 1fr;background:#facc15;border-top:3px solid #020617;}
    .maker-list{border-right:3px solid #020617;padding:.75rem;overflow:auto;background:#fde68a;}
    .maker-list-item{padding:.55rem .65rem;border-radius:12px;margin-bottom:.4rem;cursor:pointer;background:#fefce8;border:2px solid #020617;display:flex;flex-direction:column;gap:.15rem;font-size:.82rem;transition:background .15s,transform .1s;}
    .maker-list-item:hover{background:#e0f2fe;transform:translateY(-1px);}
    .maker-list-item.active{background:#a5f3fc;}
    .maker-list-item-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .maker-list-item-meta{opacity:.8;font-size:.75rem;display:flex;justify-content:space-between;gap:.3rem;}
    .maker-add-btn{width:100%;margin-top:.4rem;border-radius:999px;padding:.55rem .75rem;font-size:.85rem;justify-content:center;display:flex;align-items:center;gap:.3rem;background:linear-gradient(180deg,var(--accent3),#00a9a0);}
    .maker-main{padding:1rem 1.1rem;display:grid;grid-template-rows:auto 1fr;gap:.75rem;overflow:hidden;}
    .maker-main-header{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;}
    .maker-form{display:grid;grid-template-columns:1.35fr 1fr;gap:.9rem;height:100%;}
    .maker-field{display:flex;flex-direction:column;gap:.25rem;font-size:.8rem;}
    .maker-field label{font-weight:600;opacity:.9;}
    .maker-field input,.maker-field textarea{border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(4,2,15,0.9);color:var(--fg);padding:.45rem .55rem;font-family:inherit;font-size:.85rem;resize:vertical;min-height:2.4rem;}
    .maker-field textarea{min-height:4.4rem;}
    .maker-preview-card{background:#fefce8;border-radius:16px;padding:.75rem .9rem;box-shadow:6px 6px 0 #020617;border:3px solid #020617;display:flex;flex-direction:column;gap:.5rem;height:100%;}
    .maker-preview-question{font-weight:800;font-size:1rem;}
    .maker-preview-answer{opacity:.9;font-size:.9rem;margin-top:auto;}
    .maker-preview-image{max-width:100%;max-height:220px;border-radius:12px;margin:.35rem 0;object-fit:contain;box-shadow:0 4px 16px rgba(0,0,0,.4);display:none;}
    .maker-tag{display:inline-flex;align-items:center;gap:.25rem;padding:.1rem .5rem;border-radius:999px;background:#ffffff22;font-size:.75rem;width:max-content;}
    .maker-empty{opacity:.8;font-size:.9rem;}
    .maker-footer-note{font-size:.75rem;opacity:.7;margin-top:.45rem;}
    .maker-chip-row{display:flex;flex-wrap:wrap;gap:.4rem;font-size:.75rem;opacity:.9;}
    .maker-chip{padding:.15rem .55rem;border-radius:999px;border:2px solid #020617;background:#f9fafb;}
    .maker-mood-controls{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;font-size:.8rem;}
    .maker-mood-label{font-weight:700;}
    .maker-mood-btn{border-radius:999px;border:2px solid #020617;background:#e5e7eb;padding:.3rem .75rem;font-size:.78rem;font-weight:700;cursor:pointer;box-shadow:3px 3px 0 #020617;}
    .maker-mood-btn.active{background:#4ade80;}
    .maker-mood-swatch{display:inline-flex;align-items:center;gap:.25rem;border-radius:999px;border:2px dashed #020617;padding:.2rem .55rem;background:#fefce8;}
    .maker-mood-swatch input{border:none;background:transparent;width:2.1rem;height:2.1rem;padding:0;cursor:pointer;}
    .maker-inline-buttons{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.35rem;}
    .maker-danger{background:linear-gradient(180deg,var(--danger),#ff1744);}
    @media (max-width:900px){
      .maker-dialog{height:96vh;}
      .maker-body{grid-template-columns:1fr;}
      .maker-form{grid-template-columns:1fr;}
    }
    ::-webkit-scrollbar{width:10px;height:10px} ::-webkit-scrollbar-thumb{background:#ffffff33;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="title"><div class="logo">üéâ</div><div class="text">Trivia Studio</div></div>
        <div class="header-right">
          <div class="subtle">Use <span class="pill">Space</span> to reveal ‚Ä¢ <span class="pill">‚Üê/‚Üí</span> to navigate ‚Ä¢ <span class="pill">F</span> fullscreen</div>
          <button class="ctrl ghost header-maker-btn" id="makerOpenBtn">üõ† Trivia Maker</button>
        </div>
      </header>
      <main class="qa" role="main" aria-live="polite">
        <div class="intro-view" id="introView">
          <div class="intro-content">
            <div class="intro-emoji">üé≤‚ú®</div>
            <h1 class="intro-title">Welcome to Trivia Studio!</h1>
            
            <button class="ctrl ctrl-large" id="startBtn">üéâ Start Quiz</button>
          </div>
        </div>
        <div class="question-view" id="questionView">
          <div class="q" id="q">Loading‚Ä¶</div>
        </div>
        <div class="answer-view" id="answerView">
          <div class="answer-title" id="answerTitle"></div>
          <div class="answer-facts" id="answerFacts"></div>
        </div>
      </main>
      <footer id="footer">
        <div class="controls">
          <button class="ctrl ghost" id="prev">‚óÄ Prev</button>
          <button class="ctrl" id="reveal">üéá Show Answer</button>
          <button class="ctrl ghost" id="next">Next ‚ñ∂</button>
          <button class="ctrl secondary" id="shuffle">üîÄ Shuffle</button>
          <button class="ctrl ghost" id="autoplay">‚ñ∂Ô∏é Auto</button>
          <button class="ctrl ghost" id="fs">‚õ∂ Fullscreen</button>
          <!-- <button class="ctrl ghost" id="importBtn">‚¨á Import</button>
          <button class="ctrl ghost" id="exportBtn">‚¨Ü Export</button>
          <button class="ctrl ghost" id="helpBtn">‚ìò Help</button> -->
        </div>
        <div class="idx" id="idx">1 / 1</div>
      </footer>
      <div class="tips"></div>
    </div>
  </div>
  <div class="maker-backdrop" id="makerOverlay">
    <div class="maker-dialog">
      <div class="maker-header">
        <div class="maker-title">
          <div>Trivia Maker</div>
          <span>Design a custom trivia pack and export it as a zip</span>
        </div>
        <div class="maker-actions">
          <button class="ctrl ghost" id="makerUploadZipBtn">‚¨Ü Upload Zip</button>
          <input type="file" accept=".zip,application/zip" id="makerZipInput" class="hidden" />
          <button class="ctrl ghost" id="makerDownloadZipBtn">‚¨á Download Zip</button>
          <button class="ctrl secondary" id="makerResetBtn">‚Ü∫ Reset to defaults</button>
          <button class="ctrl" id="makerApplyBtn">‚úÖ Save & Use</button>
          <button class="ctrl ghost maker-danger" id="makerCloseBtn">‚úï Close</button>
        </div>
      </div>
      <div class="maker-body">
        <aside class="maker-list">
          <div id="makerList"></div>
          <button class="ctrl maker-add-btn" id="makerAddBtn">Ôºã Add Question</button>
          <div class="maker-footer-note">Tip: questions are grouped by category in the game.</div>
        </aside>
        <section class="maker-main">
          <div class="maker-main-header">
            <div class="maker-chip-row">
              <span class="maker-chip">Use line breaks or HTML for options</span>
              <span class="maker-chip">Images are embedded directly into the zip</span>
            </div>
            <div class="maker-mood-controls">
              <span class="maker-mood-label">Mood:</span>
              <button class="maker-mood-btn" data-mood="arcade">Arcade</button>
              <button class="maker-mood-btn" data-mood="chill">Chill</button>
              <button class="maker-mood-btn" data-mood="night">Night</button>
              <label class="maker-mood-swatch">
                Bg 1
                <input type="color" id="makerBg1Input" />
              </label>
              <label class="maker-mood-swatch">
                Bg 2
                <input type="color" id="makerBg2Input" />
              </label>
            </div>
          </div>
          <div class="maker-form" id="makerForm">
            <div>
              <div class="maker-field">
                <label for="makerCategoryInput">Category</label>
                <input id="makerCategoryInput" placeholder="e.g. General, Movies, Science" />
              </div>
              <div class="maker-field">
                <label for="makerQuestionInput">Question</label>
                <textarea id="makerQuestionInput" placeholder="Write the question. You can use line breaks or basic HTML for answer options."></textarea>
              </div>
              <div class="maker-field">
                <label for="makerAnswerInput">Answer</label>
                <input id="makerAnswerInput" placeholder="Short answer shown on reveal" />
              </div>
              <div class="maker-field">
                <label for="makerFactsInput">Extra facts (HTML allowed)</label>
                <textarea id="makerFactsInput" placeholder="Fun facts, explanations, or extra context."></textarea>
              </div>
              <div class="maker-inline-buttons">
                <button class="ctrl ghost" id="makerDuplicateBtn">Duplicate</button>
                <button class="ctrl ghost maker-danger" id="makerDeleteBtn">Delete</button>
              </div>
            </div>
            <div>
              <div class="maker-field">
                <label for="makerImageInput">Image (optional)</label>
                <input type="file" accept="image/*" id="makerImageInput" />
              </div>
              <div class="maker-preview-card">
                <div class="maker-tag">Live preview</div>
                <div class="maker-preview-question" id="makerPreviewQuestion">Your question text will appear here.</div>
                <img class="maker-preview-image" id="makerPreviewImage" alt="" />
                <div class="maker-preview-answer" id="makerPreviewAnswer">Answer and image preview update as you type.</div>
              </div>
            </div>
          </div>
          <div class="maker-empty" id="makerEmpty">Add your first question to begin.</div>
        </section>
      </div>
    </div>
  </div>
  <div class="modal" id="modal"><div class="box"><h2 style="margin:0 0 .5rem 0">Edit Questions (JSON)</h2>        <p style="margin:.2rem 0 .8rem 0;opacity:.9">Paste an object with categories like <code>{"General": [{"q":"Question","a":"Answer","facts":"HTML content with facts"}], "Movies": [...]}</code>. Your list is saved to <b>localStorage</b> only on this device.</p><textarea id="jsonArea"></textarea><div class="row"><button class="ctrl" id="saveJson">üíæ Save</button><button class="ctrl ghost" id="closeJson">Close</button><input type="file" accept="application/json" id="fileInput" class="hidden" /><button class="ctrl secondary" id="loadFile">üìÅ Load .json file</button></div></div></div>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const DEFAULT_THEME = {
      mood: 'arcade',
      bg1: '#fef9c3',
      bg2: '#a5f3fc',
      fg: '#020617',
      accent: '#f97316',
      accent2: '#ec4899',
      accent3: '#22c55e',
      danger: '#f97373'
    };

    const MOOD_PRESETS = {
      arcade: {
        mood: 'arcade',
        bg1: '#fef9c3',
        bg2: '#a5f3fc',
        fg: '#020617',
        accent: '#f97316',
        accent2: '#ec4899',
        accent3: '#22c55e',
        danger: '#f97373'
      },
      chill: {
        mood: 'chill',
        bg1: '#e0f2fe',
        bg2: '#bbf7d0',
        fg: '#0f172a',
        accent: '#0ea5e9',
        accent2: '#22c55e',
        accent3: '#6366f1',
        danger: '#f97373'
      },
      night: {
        mood: 'night',
        bg1: '#020617',
        bg2: '#1e293b',
        fg: '#e5e7eb',
        accent: '#a855f7',
        accent2: '#22d3ee',
        accent3: '#facc15',
        danger: '#fb7185'
      }
    };

    const LS_THEME_KEY = 'trivia_theme_v1';

    function normalizeTheme(theme) {
      const base = { ...DEFAULT_THEME };
      if (!theme || typeof theme !== 'object') return base;
      const out = { ...base };
      ['bg1','bg2','fg','accent','accent2','accent3','danger','mood'].forEach(key => {
        if (typeof theme[key] === 'string' && theme[key].trim()) {
          out[key] = theme[key].trim();
        }
      });
      if (out.mood && MOOD_PRESETS[out.mood]) {
        return { ...MOOD_PRESETS[out.mood], ...out };
      }
      return out;
    }

    function loadTheme() {
      try {
        const raw = localStorage.getItem(LS_THEME_KEY);
        if (raw) {
          return normalizeTheme(JSON.parse(raw));
        }
      } catch (err) {
        console.warn('Ignoring invalid saved theme', err);
      }
      return { ...DEFAULT_THEME };
    }

    function saveTheme(theme) {
      try {
        localStorage.setItem(LS_THEME_KEY, JSON.stringify(theme));
      } catch (err) {
        console.warn('Could not save theme', err);
      }
    }

    function applyTheme(theme) {
      const t = normalizeTheme(theme);
      const root = document.documentElement;
      root.style.setProperty('--bg1', t.bg1);
      root.style.setProperty('--bg2', t.bg2);
      root.style.setProperty('--fg', t.fg);
      root.style.setProperty('--accent', t.accent);
      root.style.setProperty('--accent2', t.accent2);
      root.style.setProperty('--accent3', t.accent3);
      root.style.setProperty('--danger', t.danger);
      root.style.setProperty('--shadow', '8px 8px 0 #020617');
      return t;
    }

    let DEFAULT_QA = null;
    
    // Load questions from external JSON file
    async function loadDefaultQuestions() {
      try {
        const response = await fetch('questions.json');
        if (!response.ok) throw new Error('Failed to load questions');
        DEFAULT_QA = await response.json();
        console.log('Loaded questions from JSON file:', DEFAULT_QA);
        console.log('Total questions loaded:', Object.keys(DEFAULT_QA).reduce((sum, cat) => sum + DEFAULT_QA[cat].length, 0));
        initializeApp();
      } catch (error) {
        console.error('Error loading questions:', error);
        // Fallback to minimal inline questions if external file fails
        DEFAULT_QA = {
          "General": [
            {q:"Which planet is known as the Red Planet?",a:"Mars",facts:"<p>Mars appears red because of iron oxide (rust) on its surface.</p>"},
            {q:"What is the largest ocean on Earth?",a:"The Pacific Ocean",facts:"<p>The Pacific covers more than 30% of the Earth's surface.</p>"}
          ],
          "Movies": [
            {q:"Who directed the movie <em>Inception</em>?",a:"Christopher Nolan",facts:"<p>Nolan is also known for <em>The Dark Knight</em> trilogy and <em>Interstellar</em>.</p>"},
            {q:"Which movie popularized the phrase ‚ÄúMay the Force be with you‚Äù?",a:"Star Wars",facts:"<p>The line became iconic after the original 1977 film.</p>"}
          ]
        };
        console.warn('Using fallback sample questions');
        initializeApp();
      }
    }
    
    function initializeApp() {
      const LS_KEY = 'diwali_trivia_qa_v1';
      const LS_IDX = 'diwali_trivia_idx_v1';
      const LS_AUTOPLAY = 'diwali_trivia_autoplay_v1';
      const LS_INTRO = 'diwali_trivia_intro_seen_v1';

      let qaData = loadQA();
      let qa = flattenQA(qaData);
      let order = [...Array(qa.length).keys()];
      let idx = 0;
      let showAnswer = false;
      let autoplay = false;
      let intervalMs = 12000;
      let timer = null;
      let quizStarted = false;

      const qEl = document.getElementById('q');
      const idxEl = document.getElementById('idx');
      const footer = document.getElementById('footer');

      const introView = document.getElementById('introView');
      const startBtn = document.getElementById('startBtn');

      const questionView = document.getElementById('questionView');
      const answerView = document.getElementById('answerView');
      const answerTitle = document.getElementById('answerTitle');
      const answerFacts = document.getElementById('answerFacts');

      const btnPrev = document.getElementById('prev');
      const btnNext = document.getElementById('next');
      const btnReveal = document.getElementById('reveal');
      const btnShuffle = document.getElementById('shuffle');
      const btnAuto = document.getElementById('autoplay');
      const btnFS = document.getElementById('fs');
      const btnHelp = document.getElementById('helpBtn');

      const modal = document.getElementById('modal');
      const jsonArea = document.getElementById('jsonArea');
      const btnSaveJson = document.getElementById('saveJson');
      const btnCloseJson = document.getElementById('closeJson');
      const fileInput = document.getElementById('fileInput');
      const btnLoadFile = document.getElementById('loadFile');

      const makerOpenBtn = document.getElementById('makerOpenBtn');
      const makerOverlay = document.getElementById('makerOverlay');
      const makerList = document.getElementById('makerList');
      const makerAddBtn = document.getElementById('makerAddBtn');
      const makerCategoryInput = document.getElementById('makerCategoryInput');
      const makerQuestionInput = document.getElementById('makerQuestionInput');
      const makerAnswerInput = document.getElementById('makerAnswerInput');
      const makerFactsInput = document.getElementById('makerFactsInput');
      const makerImageInput = document.getElementById('makerImageInput');
      const makerPreviewQuestion = document.getElementById('makerPreviewQuestion');
      const makerPreviewImage = document.getElementById('makerPreviewImage');
      const makerPreviewAnswer = document.getElementById('makerPreviewAnswer');
      const makerDuplicateBtn = document.getElementById('makerDuplicateBtn');
      const makerDeleteBtn = document.getElementById('makerDeleteBtn');
      const makerApplyBtn = document.getElementById('makerApplyBtn');
      const makerCloseBtn = document.getElementById('makerCloseBtn');
      const makerDownloadZipBtn = document.getElementById('makerDownloadZipBtn');
      const makerUploadZipBtn = document.getElementById('makerUploadZipBtn');
      const makerZipInput = document.getElementById('makerZipInput');
      const makerResetBtn = document.getElementById('makerResetBtn');
      const makerForm = document.getElementById('makerForm');
      const makerEmpty = document.getElementById('makerEmpty');
      const makerBg1Input = document.getElementById('makerBg1Input');
      const makerBg2Input = document.getElementById('makerBg2Input');
      const makerMoodButtons = Array.from(document.querySelectorAll('.maker-mood-btn'));

      let theme = applyTheme(loadTheme());
      let makerQuestions = [];
      let makerSelectedId = null;

      checkIntro();

      if (startBtn) startBtn.onclick = startQuiz;
      if (btnPrev) btnPrev.onclick = prev;
      if (btnNext) btnNext.onclick = next;
      if (btnReveal) btnReveal.onclick = toggleAnswer;
      if (btnShuffle) btnShuffle.onclick = shuffleAll;
      if (btnAuto) btnAuto.onclick = toggleAutoplay;
      if (btnFS) btnFS.onclick = toggleFullscreen;
      if (btnHelp) btnHelp.onclick = showHelp;

      if (btnSaveJson) btnSaveJson.onclick = saveJson;
      if (btnCloseJson) btnCloseJson.onclick = closeEditor;
      if (btnLoadFile && fileInput) btnLoadFile.onclick = () => fileInput.click();
      if (fileInput) fileInput.onchange = onFileImport;

      if (makerOpenBtn) makerOpenBtn.onclick = () => {
        populateMakerFromQA();
        openMaker();
      };
      if (makerCloseBtn) makerCloseBtn.onclick = closeMaker;
      if (makerAddBtn) makerAddBtn.onclick = addMakerQuestion;
      if (makerDuplicateBtn) makerDuplicateBtn.onclick = duplicateMakerQuestion;
      if (makerDeleteBtn) makerDeleteBtn.onclick = deleteMakerQuestion;
      if (makerApplyBtn) makerApplyBtn.onclick = () => {
        applyMakerChanges();
        closeMaker();
      };
      if (makerResetBtn) makerResetBtn.onclick = resetToDefaults;
      if (makerDownloadZipBtn) makerDownloadZipBtn.onclick = exportZipPack;
      if (makerUploadZipBtn && makerZipInput) {
        makerUploadZipBtn.onclick = () => makerZipInput.click();
        makerZipInput.onchange = e => {
          const file = e.target.files && e.target.files[0];
          if (file) importZipPack(file);
          e.target.value = '';
        };
      }

      if (makerBg1Input) makerBg1Input.addEventListener('input', () => setCustomBackground());
      if (makerBg2Input) makerBg2Input.addEventListener('input', () => setCustomBackground());
      if (makerMoodButtons.length) {
        makerMoodButtons.forEach(btn => {
          btn.onclick = () => {
            const moodId = btn.dataset.mood;
            if (moodId) setMood(moodId);
          };
        });
      }

      if (makerCategoryInput) makerCategoryInput.addEventListener('input', syncMakerFormToState);
      if (makerQuestionInput) makerQuestionInput.addEventListener('input', syncMakerFormToState);
      if (makerAnswerInput) makerAnswerInput.addEventListener('input', syncMakerFormToState);
      if (makerFactsInput) makerFactsInput.addEventListener('input', syncMakerFormToState);
      if (makerImageInput) {
        makerImageInput.onchange = e => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            const current = getCurrentMakerQuestion();
            if (!current) return;
            current.image = String(reader.result || '');
            renderMakerPreview();
          };
          reader.readAsDataURL(file);
        };
      }

      window.onkeydown = e => {
        const k = e.key.toLowerCase();
        if (!quizStarted && k === 'enter') {
          e.preventDefault();
          startQuiz();
          return;
        }
        if (makerOverlay && makerOverlay.classList.contains('show')) {
          if (k === 'escape') {
            e.preventDefault();
            closeMaker();
          }
          return;
        }
        if (!quizStarted) return;
        if (['arrowright', 'enter'].includes(k)) {
          e.preventDefault();
          if (!showAnswer) toggleAnswer(); else next();
        } else if (k === ' ') {
          e.preventDefault();
          toggleAnswer();
        } else if (['arrowleft', 'backspace'].includes(k)) {
          e.preventDefault();
          prev();
        } else if (k === 'r') {
          shuffleAll();
        } else if (k === 'a') {
          toggleAutoplay();
        } else if (k === 'f') {
          toggleFullscreen();
        } else if (k === 'i') {
          e.preventDefault();
          populateMakerFromQA();
          openMaker();
        } else if (k === '+') {
          intervalMs = Math.max(4000, intervalMs - 1000);
          updateAutoplay(true);
        } else if (k === '-') {
          intervalMs = Math.min(30000, intervalMs + 1000);
          updateAutoplay(true);
        } else if (k === 'h') {
          showHelp();
        }
      };

      const qaContainer = document.querySelector('.qa');
      if (qaContainer) {
        qaContainer.onclick = e => {
          if (!quizStarted) return;
          const target = e.target;
          if (target.closest('.question-view') || target.closest('.answer-view')) {
            toggleAnswer();
          }
        };
      }

      function checkIntro() {
        const seen = localStorage.getItem(LS_INTRO);
        if (seen === '1') {
          quizStarted = true;
          introView.classList.remove('show');
          questionView.classList.remove('hidden');
          footer.classList.remove('hidden');
          render();
          updateAutoplay();
        } else {
          showIntro();
        }
      }

      function showIntro() {
        quizStarted = false;
        if (introView) introView.classList.add('show');
        if (questionView) questionView.classList.add('hidden');
        if (answerView) answerView.classList.remove('show');
        if (footer) footer.classList.add('hidden');
      }

      function startQuiz() {
        quizStarted = true;
        localStorage.setItem(LS_INTRO, '1');
        if (introView) introView.classList.remove('show');
        if (questionView) questionView.classList.remove('hidden');
        if (footer) footer.classList.remove('hidden');
        qaData = loadQA();
        qa = flattenQA(qaData);
        order = [...Array(qa.length).keys()];
        const storedIdx = Number(localStorage.getItem(LS_IDX) || '0');
        idx = Number.isFinite(storedIdx) && storedIdx >= 0 && storedIdx < qa.length ? storedIdx : 0;
        showAnswer = false;
        render();
        const storedAuto = localStorage.getItem(LS_AUTOPLAY) === '1';
        autoplay = storedAuto;
        updateAutoplay();
      }

      function flattenQA(qaDataObj) {
        const flat = [];
        Object.keys(qaDataObj).forEach(category => {
          qaDataObj[category].forEach(item => {
            flat.push({ ...item, category });
          });
        });
        return flat;
      }

      function render() {
        if (!qa.length) {
          qEl.textContent = 'No questions yet ‚Äì open the Trivia Maker to add some!';
          answerTitle.textContent = '';
          answerFacts.innerHTML = '';
          idxEl.textContent = '0 / 0';
          return;
        }
        const i = order[idx];
        const item = qa[i];
        let questionHTML = `<div style="color:var(--accent2);font-size:0.6em;margin-bottom:0.5em;opacity:0.9;font-weight:600;">${item.category}</div>`;
        if (item.image) {
          questionHTML += `<img src="${item.image}" alt="Question image" class="question-image" onerror="this.style.display='none'">`;
        }
        questionHTML += item.q;
        qEl.innerHTML = questionHTML;
        answerTitle.textContent = item.a || '';
        answerFacts.innerHTML = item.facts || '<p>No additional facts available.</p>';
        if (showAnswer) {
          questionView.classList.add('hidden');
          answerView.classList.add('show');
          btnReveal.textContent = 'üîô Back to Question';
        } else {
          questionView.classList.remove('hidden');
          answerView.classList.remove('show');
          btnReveal.textContent = 'üéá Show Answer';
        }
        idxEl.textContent = `${idx + 1} / ${qa.length}`;
        localStorage.setItem(LS_IDX, String(idx));
      }

      function next() {
        if (!qa.length) return;
        showAnswer = false;
        idx = (idx + 1) % qa.length;
        render();
        resetAutoplayTick();
      }

      function prev() {
        if (!qa.length) return;
        showAnswer = false;
        idx = (idx - 1 + qa.length) % qa.length;
        render();
        resetAutoplayTick();
      }

      function toggleAnswer() {
        if (!qa.length) return;
        showAnswer = !showAnswer;
        render();
        resetAutoplayTick();
      }

      function shuffleAll() {
        order = shuffle([...Array(qa.length).keys()]);
        idx = 0;
        showAnswer = false;
        render();
      }

      function toggleAutoplay() {
        autoplay = !autoplay;
        localStorage.setItem(LS_AUTOPLAY, autoplay ? '1' : '0');
        updateAutoplay();
      }

      function updateAutoplay() {
        if (!btnAuto) return;
        btnAuto.textContent = autoplay ? `‚è∏ Auto (${Math.round(intervalMs / 1000)}s)` : '‚ñ∂Ô∏é Auto';
        if (autoplay) {
          clearInterval(timer);
          timer = setInterval(() => {
            if (!showAnswer) {
              toggleAnswer();
            } else {
              next();
            }
          }, intervalMs);
        } else {
          clearInterval(timer);
          timer = null;
        }
      }

      function resetAutoplayTick() {
        if (autoplay) updateAutoplay();
      }

      function toggleFullscreen() {
        const el = document.documentElement;
        if (!document.fullscreenElement) {
          el.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      }

      function openEditor() {
        if (!modal || !jsonArea) return;
        jsonArea.value = JSON.stringify(qaData, null, 2);
        modal.style.display = 'grid';
      }

      function closeEditor() {
        if (!modal) return;
        modal.style.display = 'none';
      }

      function normalizeQA(parsed) {
        if (typeof parsed !== 'object' || parsed === null) {
          throw new Error('JSON must be an object with categories');
        }
        const cleaned = {};
        let totalItems = 0;
        Object.keys(parsed).forEach(category => {
          if (!Array.isArray(parsed[category])) {
            throw new Error(`Category '${category}' must be an array`);
          }
          const items = parsed[category]
            .map(o => ({
              q: String(o.q || '').trim(),
              a: String(o.a || '').trim(),
              facts: o.facts || '',
              image: o.image || ''
            }))
            .filter(o => o.q);
          if (items.length > 0) {
            cleaned[category] = items;
            totalItems += items.length;
          }
        });
        if (!totalItems) {
          throw new Error('No valid items. Include objects with {q, a, facts} in categories.');
        }
        return cleaned;
      }

      function saveJson() {
        try {
          const parsed = JSON.parse(jsonArea.value);
          qaData = normalizeQA(parsed);
          qa = flattenQA(qaData);
          order = [...Array(qa.length).keys()];
          idx = 0;
          showAnswer = false;
          localStorage.setItem(LS_KEY, JSON.stringify(qaData));
          render();
          closeEditor();
        } catch (err) {
          alert('Invalid JSON: ' + err.message);
        }
      }

      function onFileImport(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          jsonArea.value = String(reader.result || '');
        };
        reader.readAsText(file);
      }

      function loadQA() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            console.log('Loaded questions from localStorage');
            return normalizeQA(parsed);
          }
        } catch (err) {
          console.warn('Ignoring invalid local trivia data', err);
        }
        console.log('Using DEFAULT_QA from JSON file');
        return normalizeQA(DEFAULT_QA);
      }

      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function showHelp() {
        alert(`Controls:\n\nSpace / Click  ‚Äî Reveal/Hide answer\n‚Üí / Enter       ‚Äî Reveal then Next\n‚Üê / Backspace   ‚Äî Previous\nR               ‚Äî Shuffle order\nA               ‚Äî Toggle Auto-play\n+ / -           ‚Äî Auto speed ¬±1s (4‚Äì30s)\nF               ‚Äî Fullscreen\nI               ‚Äî Trivia Maker\nH               ‚Äî This help`);
      }

      function openMaker() {
        if (!makerOverlay) return;
        makerOverlay.classList.add('show');
        renderMakerUI();
        updateMoodControls();
      }

      function closeMaker() {
        if (!makerOverlay) return;
        makerOverlay.classList.remove('show');
      }

      function populateMakerFromQA() {
        makerQuestions = [];
        Object.keys(qaData).forEach(category => {
          qaData[category].forEach(item => {
            makerQuestions.push({
              id: makeId(),
              category,
              q: item.q || '',
              a: item.a || '',
              facts: item.facts || '',
              image: item.image || ''
            });
          });
        });
        if (!makerQuestions.length) {
          makerQuestions.push({
            id: makeId(),
            category: 'General',
            q: '',
            a: '',
            facts: '',
            image: ''
          });
        }
        makerSelectedId = makerQuestions[0].id;
        renderMakerUI();
      }

      function makeId() {
        return 'q_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function getCurrentMakerQuestion() {
        if (!makerSelectedId) return null;
        return makerQuestions.find(q => q.id === makerSelectedId) || null;
      }

      function renderMakerUI() {
        if (!makerList || !makerForm || !makerEmpty) return;
        makerList.innerHTML = '';
        makerQuestions.forEach((qItem, index) => {
          const div = document.createElement('div');
          div.className = 'maker-list-item' + (qItem.id === makerSelectedId ? ' active' : '');
          div.dataset.id = qItem.id;
          const label = qItem.q || '(untitled question)';
          const short = label.length > 40 ? label.slice(0, 40) + '‚Ä¶' : label;
          div.innerHTML = `<div class="maker-list-item-title">Question ${index + 1}</div><div class="maker-list-item-meta"><span>${qItem.category || 'No category'}</span><span>${short}</span></div>`;
          div.onclick = () => {
            makerSelectedId = qItem.id;
            renderMakerUI();
          };
          makerList.appendChild(div);
        });
        if (makerQuestions.length) {
          makerForm.style.display = 'grid';
          makerEmpty.style.display = 'none';
          renderMakerForm();
        } else {
          makerForm.style.display = 'none';
          makerEmpty.style.display = 'block';
        }
      }

      function renderMakerForm() {
        const current = getCurrentMakerQuestion();
        if (!current) return;
        if (makerCategoryInput) makerCategoryInput.value = current.category || '';
        if (makerQuestionInput) makerQuestionInput.value = current.q || '';
        if (makerAnswerInput) makerAnswerInput.value = current.a || '';
        if (makerFactsInput) makerFactsInput.value = current.facts || '';
        renderMakerPreview();
      }

      function renderMakerPreview() {
        const current = getCurrentMakerQuestion();
        if (!current) return;
        if (makerPreviewQuestion) {
          makerPreviewQuestion.innerHTML = current.q || 'Your question text will appear here.';
        }
        if (makerPreviewAnswer) {
          makerPreviewAnswer.textContent = current.a || 'Answer and image preview update as you type.';
        }
        if (makerPreviewImage) {
          if (current.image) {
            makerPreviewImage.src = current.image;
            makerPreviewImage.style.display = 'block';
          } else {
            makerPreviewImage.style.display = 'none';
            makerPreviewImage.removeAttribute('src');
          }
        }
      }

      function syncMakerFormToState() {
        const current = getCurrentMakerQuestion();
        if (!current) return;
        if (makerCategoryInput) current.category = makerCategoryInput.value;
        if (makerQuestionInput) current.q = makerQuestionInput.value;
        if (makerAnswerInput) current.a = makerAnswerInput.value;
        if (makerFactsInput) current.facts = makerFactsInput.value;
        renderMakerUI();
      }

      function addMakerQuestion() {
        const last = makerQuestions[makerQuestions.length - 1];
        const newQuestion = {
          id: makeId(),
          category: last ? last.category : 'General',
          q: '',
          a: '',
          facts: '',
          image: ''
        };
        makerQuestions.push(newQuestion);
        makerSelectedId = newQuestion.id;
        renderMakerUI();
      }

      function duplicateMakerQuestion() {
        const current = getCurrentMakerQuestion();
        if (!current) return;
        const idxQ = makerQuestions.findIndex(q => q.id === current.id);
        const clone = {
          ...current,
          id: makeId()
        };
        makerQuestions.splice(idxQ + 1, 0, clone);
        makerSelectedId = clone.id;
        renderMakerUI();
      }

      function deleteMakerQuestion() {
        const current = getCurrentMakerQuestion();
        if (!current) return;
        if (!confirm('Delete this question?')) return;
        makerQuestions = makerQuestions.filter(q => q.id !== current.id);
        if (makerQuestions.length) {
          makerSelectedId = makerQuestions[0].id;
        } else {
          makerSelectedId = null;
        }
        renderMakerUI();
      }

      function updateMoodControls() {
        if (makerBg1Input) makerBg1Input.value = theme.bg1;
        if (makerBg2Input) makerBg2Input.value = theme.bg2;
        if (makerMoodButtons && makerMoodButtons.length) {
          makerMoodButtons.forEach(btn => {
            const moodId = btn.dataset.mood;
            btn.classList.toggle('active', !!moodId && moodId === theme.mood);
          });
        }
      }

      function setMood(moodId) {
        if (!moodId || !MOOD_PRESETS[moodId]) return;
        theme = { ...MOOD_PRESETS[moodId] };
        theme.mood = moodId;
        applyTheme(theme);
        saveTheme(theme);
        updateMoodControls();
      }

      function setCustomBackground() {
        const bg1 = makerBg1Input ? makerBg1Input.value || theme.bg1 : theme.bg1;
        const bg2 = makerBg2Input ? makerBg2Input.value || theme.bg2 : theme.bg2;
        theme = normalizeTheme({ ...theme, bg1, bg2, mood: 'custom' });
        applyTheme(theme);
        saveTheme(theme);
        updateMoodControls();
      }

      function buildQAFromMaker() {
        const raw = {};
        makerQuestions.forEach(qItem => {
          const category = (qItem.category || 'General').trim() || 'General';
          if (!raw[category]) raw[category] = [];
          raw[category].push({
            q: (qItem.q || '').trim(),
            a: (qItem.a || '').trim(),
            facts: qItem.facts || '',
            image: qItem.image || ''
          });
        });
        return normalizeQA(raw);
      }

      function applyMakerChanges() {
        try {
          qaData = buildQAFromMaker();
          qa = flattenQA(qaData);
          order = [...Array(qa.length).keys()];
          idx = 0;
          showAnswer = false;
          localStorage.setItem(LS_KEY, JSON.stringify(qaData));
          render();
        } catch (err) {
          alert('Could not save questions: ' + err.message);
        }
      }

      async function exportZipPack() {
        try {
          const packQA = makerQuestions.length ? buildQAFromMaker() : qaData;
          if (!window.JSZip) {
            alert('Zip support is not available. Check your internet connection and reload.');
            return;
          }
          const zip = new JSZip();
          zip.file('questions.json', JSON.stringify(packQA, null, 2));
          const blob = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'trivia-pack.zip';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('Failed to create zip: ' + err.message);
        }
      }

      async function importZipPack(file) {
        try {
          if (!window.JSZip) {
            alert('Zip support is not available. Check your internet connection and reload.');
            return;
          }
          const zip = await JSZip.loadAsync(file);
          let entry = zip.file('questions.json')[0];
          if (!entry) {
            const jsonFiles = zip.file(/\.json$/i);
            if (!jsonFiles.length) throw new Error('No .json file found inside zip');
            entry = jsonFiles[0];
          }
          const text = await entry.async('string');
          const parsed = JSON.parse(text);
          qaData = normalizeQA(parsed);
          qa = flattenQA(qaData);
          order = [...Array(qa.length).keys()];
          idx = 0;
          showAnswer = false;
          localStorage.setItem(LS_KEY, JSON.stringify(qaData));
          render();
          populateMakerFromQA();
          alert('Trivia pack loaded!');
        } catch (err) {
          alert('Could not read zip: ' + err.message);
        }
      }

      function resetToDefaults() {
        if (!confirm('Reset to the original sample trivia pack?')) return;
        try {
          qaData = normalizeQA(DEFAULT_QA);
          qa = flattenQA(qaData);
          order = [...Array(qa.length).keys()];
          idx = 0;
          showAnswer = false;
          localStorage.removeItem(LS_KEY);
          render();
          populateMakerFromQA();
        } catch (err) {
          alert('Failed to reset: ' + err.message);
        }
      }
    }
    
    // Load questions and start the app
    loadDefaultQuestions();
  </script>
</body>
</html>
